# Telegram Digest Bot Technical Design

## Overview

This system ingests Telegram channel messages, filters and scores them with LLMs, and publishes a curated digest. It runs as a single binary with multiple modes:

- `--mode=bot`: admin bot and digest posting
- `--mode=reader`: MTProto reader (user account) for channel intake
- `--mode=worker`: processing pipeline (filters, dedup, scoring)
- `--mode=digest`: digest scheduler and renderer

Utility tools live under `cmd/tools/` (evaluation and labeling).

## Component Responsibilities

- **Bot**: admin commands, settings management, digest posting.
- **Reader**: joins channels, pulls raw messages, stores them.
- **Worker**: filters, deduplicates, enriches, and scores messages.
- **Digest scheduler**: selects items, clusters, renders, and posts digests.

## Data Flow

1. Reader stores raw messages in Postgres.
2. Worker filters and scores messages, producing digest items.
3. Scheduler builds digest windows and selects items.
4. Bot posts the digest to the target chat and marks items as digested.

## Storage & Migrations

- Postgres is the source of truth for channels, raw messages, items, embeddings, clusters, and digests.
- Migrations live in `migrations/`.
- SQL access is generated by sqlc under `internal/storage/sqlc/`.

Refer to migrations for exact schema details. The app code uses repository interfaces per domain package (see `docs/architecture.md`).

## Scheduling

- Default mode uses `digest_window`.
- When a schedule is configured, the window is derived from the schedule cadence.
- Schedule data is stored in `settings` under `digest_schedule`.

See `docs/features/digest-schedule.md` for details.

## Configuration

- Base configuration comes from `.env` (see `.env.example`).
- Runtime overrides are stored in the `settings` table.
- LLM models and thresholds are configured via env vars and settings keys.

## Observability

- Metrics are exposed on the health port (Prometheus format).
- Structured logs are emitted by each component.
- Leader election ensures a single active digest scheduler when deployed as multiple replicas.

## Deployment

- Docker Compose: `deploy/compose/`
- Kubernetes manifests: `deploy/k8s/`

Each mode can be run as a separate service using the same container image and `--mode` flag.

## Bot Commands

Use `/help` or `/help <topic>` in the bot for the current command list. Feature-specific documentation lives in `docs/features/`.
