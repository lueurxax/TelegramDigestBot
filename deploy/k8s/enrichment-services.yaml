apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: yacy-data-pvc
  namespace: digest
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: digest-yacy
  namespace: digest
spec:
  replicas: 1
  selector:
    matchLabels:
      app: digest-yacy
  template:
    metadata:
      labels:
        app: digest-yacy
    spec:
      enableServiceLinks: false
      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"
      initContainers:
      - name: yacy-data-fix
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          rm -f /opt/yacy_search_server/DATA/yacy.running || true
          for f in /opt/yacy_search_server/DATA/SETTINGS/*.properties /opt/yacy_search_server/DATA/SETTINGS/*.conf /opt/yacy_search_server/DATA/SETTINGS/yacy.conf; do
            if [ -f "$f" ]; then
              sed -i 's|tcp://[^:]*:||g' "$f"
            fi
          done
        volumeMounts:
        - name: yacy-data
          mountPath: /opt/yacy_search_server/DATA
      containers:
      - name: yacy
        image: yacy/yacy_search_server:latest
        ports:
        - containerPort: 8090
        env:
        - name: JAVA_TOOL_OPTIONS
          value: "-Xms512m -Xmx1536m"
        volumeMounts:
        - name: yacy-data
          mountPath: /opt/yacy_search_server/DATA
        resources:
          requests:
            memory: "1536Mi"
            cpu: "250m"
          limits:
            memory: "3Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /
            port: 8090
          initialDelaySeconds: 30
          periodSeconds: 20
        readinessProbe:
          httpGet:
            path: /
            port: 8090
          initialDelaySeconds: 15
          periodSeconds: 10
      volumes:
      - name: yacy-data
        persistentVolumeClaim:
          claimName: yacy-data-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: yacy
  namespace: digest
spec:
  selector:
    app: digest-yacy
  ports:
  - name: http
    port: 8090
    targetPort: 8090
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: yacy-seeds
  namespace: digest
data:
  seeds.txt: |
    reuters.com
    apnews.com
    bbc.com
    aljazeera.com
    dw.com
    nature.com
    sciencemag.org
    arxiv.org
    mit.edu
    wired.com
    pravda.com.ua
    suspilne.media
    unian.net
    ukrinform.net
    meduza.io
    theins.ru
    novayagazeta.eu
    who.int
    un.org
    europa.eu
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: yacy-bootstrap
  namespace: digest
data:
  bootstrap.sh: |
    #!/bin/sh
    set -euo pipefail

    YACY_URL="${YACY_URL:-http://yacy:8090}"
    YACY_USER="${YACY_USER:-}"
    YACY_PASSWORD="${YACY_PASSWORD:-}"

    auth=""
    if [ -n "$YACY_USER" ] && [ -n "$YACY_PASSWORD" ]; then
      auth="-u ${YACY_USER}:${YACY_PASSWORD}"
    fi

    while IFS= read -r line; do
      line="$(echo "$line" | sed 's/#.*//' | xargs)"
      if [ -z "$line" ]; then
        continue
      fi

      url="$line"
      case "$url" in
        http://*|https://*) ;;
        *) url="https://$url" ;;
      esac

      curl -fsS $auth "${YACY_URL}/Crawler_p.html?crawlingstart=${url}&crawlingDepth=2&crawlingMode=url" >/dev/null || true
    done < /config/seeds.txt
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: yacy-seed-bootstrap
  namespace: digest
spec:
  schedule: "0 2 * * *"
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: bootstrap
            image: curlimages/curl:8.6.0
            command: ["/bin/sh", "/config/bootstrap.sh"]
            env:
            - name: YACY_URL
              value: "http://yacy:8090"
            volumeMounts:
            - name: yacy-seeds
              mountPath: /config/seeds.txt
              subPath: seeds.txt
            - name: yacy-bootstrap
              mountPath: /config/bootstrap.sh
              subPath: bootstrap.sh
          volumes:
          - name: yacy-seeds
            configMap:
              name: yacy-seeds
          - name: yacy-bootstrap
            configMap:
              name: yacy-bootstrap
              defaultMode: 0755
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: searxng-config
  namespace: digest
data:
  settings.yml: |
    use_default_settings: true
    server:
      bind_address: 0.0.0.0
      port: 8080
      secret_key: "change-me"
      limiter: false
    search:
      safe_search: 0
      formats:
      - html
      - json
    engines:
    - name: duckduckgo
      disabled: false
    - name: wikipedia
      disabled: false
    - name: arxiv
      disabled: false
    - name: crossref
      disabled: false
    - name: ahmia
      disabled: true
    - name: torch
      disabled: true
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: digest-searxng
  namespace: digest
spec:
  replicas: 1
  selector:
    matchLabels:
      app: digest-searxng
  template:
    metadata:
      labels:
        app: digest-searxng
    spec:
      initContainers:
      - name: searxng-config-init
        image: searxng/searxng:latest
        command:
        - sh
        - -c
        - |
          cp /config/settings.yml /etc/searxng/settings.yml
          cp /usr/local/searxng/searx/limiter.toml /etc/searxng/limiter.toml
        volumeMounts:
        - name: searxng-config
          mountPath: /config
        - name: searxng-etc
          mountPath: /etc/searxng
      containers:
      - name: searxng
        image: searxng/searxng:latest
        ports:
        - containerPort: 8080
        volumeMounts:
        - name: searxng-etc
          mountPath: /etc/searxng
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 20
          periodSeconds: 20
        readinessProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
      volumes:
      - name: searxng-config
        configMap:
          name: searxng-config
      - name: searxng-etc
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: searxng
  namespace: digest
spec:
  selector:
    app: digest-searxng
  ports:
  - name: http
    port: 8080
    targetPort: 8080
