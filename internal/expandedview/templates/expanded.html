<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>{{.Item.Topic}} - Digest Item</title>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap");
        :root {
            --color-bg-primary: #f7f1e7;
            --color-bg-secondary: #fffaf4;
            --color-bg-tertiary: rgba(15, 23, 42, 0.04);
            --color-text-primary: #0f172a;
            --color-text-secondary: #334155;
            --color-text-muted: #64748b;
            --color-accent-primary: #f05d5e;
            --color-accent-hover: #e04a4b;
            --color-success: #15803d;
            --color-warning: #b45309;
            --color-error: #dc2626;
            --color-border-subtle: rgba(15, 23, 42, 0.08);
            --color-border-default: rgba(15, 23, 42, 0.16);
            --shadow-sm: 0 10px 30px rgba(15, 23, 42, 0.12);
            --shadow-md: 0 20px 50px rgba(15, 23, 42, 0.18);
            --radius-sm: 8px;
            --radius-md: 14px;
            --radius-lg: 18px;
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: "IBM Plex Sans", "Noto Sans", sans-serif;
            background:
                radial-gradient(900px 400px at 8% -10%, rgba(240, 93, 94, 0.18), transparent 60%),
                radial-gradient(800px 380px at 92% 0%, rgba(47, 140, 159, 0.16), transparent 55%),
                linear-gradient(180deg, var(--color-bg-primary) 0%, #ecf7f4 100%);
            color: var(--color-text-primary);
            line-height: 1.6;
            padding: var(--space-4);
        }
        a { color: #2f8c9f; text-decoration: none; }
        a:hover { color: var(--color-accent-primary); text-decoration: underline; }

        .container { max-width: 800px; margin: 0 auto; }

        .card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-4);
            box-shadow: var(--shadow-sm);
        }

        h1 {
            font-family: "Space Grotesk", "IBM Plex Sans", sans-serif;
            font-size: 1.65rem;
            font-weight: 700;
            margin-bottom: var(--space-2);
            color: var(--color-text-primary);
        }
        h2 {
            font-family: "Space Grotesk", "IBM Plex Sans", sans-serif;
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--color-text-muted);
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-border-subtle);
        }

        .meta {
            font-size: 0.875rem;
            color: var(--color-text-muted);
            margin-bottom: var(--space-4);
        }
        .meta a { color: var(--color-accent-primary); }

        /* Score bars */
        .score-row {
            display: flex;
            gap: var(--space-6);
            margin: var(--space-4) 0;
            flex-wrap: wrap;
        }
        .score-item { flex: 1; min-width: 140px; max-width: 200px; }
        .score-bar {
            height: 6px;
            background: var(--color-border-subtle);
            border-radius: 9999px;
            overflow: hidden;
        }
        .score-fill {
            height: 100%;
            background: var(--color-accent-primary);
            border-radius: 9999px;
            transition: width 0.3s ease;
        }
        .score-fill--success { background: var(--color-success); }
        .score-fill--warning { background: var(--color-warning); }
        .score-meta {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-top: var(--space-1);
        }
        .score-value {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-text-primary);
            font-variant-numeric: tabular-nums;
        }
        .score-label {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .media-container {
            margin-top: var(--space-4);
            text-align: center;
        }
        .media-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }

        .summary {
            font-size: 1.0625rem;
            line-height: 1.7;
            color: var(--color-text-primary);
        }

        .annotate-actions {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            flex-wrap: wrap;
        }
        .annotate-btn {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            border: 1px solid var(--color-border-subtle);
            background: #fff;
            cursor: pointer;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .annotate-btn.good { color: var(--color-success); }
        .annotate-btn.bad { color: var(--color-warning); }
        .annotate-btn.irrelevant { color: var(--color-error); }
        .annotate-btn.note { color: var(--color-text-muted); }
        .annotate-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .annotate-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            padding: var(--space-1) var(--space-2);
            border-radius: 999px;
            border: 1px solid var(--color-border-subtle);
            background: var(--color-bg-tertiary);
        }
        .annotate-note {
            margin-top: var(--space-2);
            display: none;
        }
        .annotate-note input {
            width: 100%;
            padding: 8px 10px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-border-subtle);
            font-size: 0.9rem;
        }
        .annotate-error {
            margin-top: var(--space-2);
            color: var(--color-error);
            font-size: 0.85rem;
        }

        .original-text {
            background: var(--color-bg-tertiary);
            border-left: 3px solid var(--color-accent-primary);
            padding: var(--space-4);
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 400px;
            overflow-y: auto;
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
        }

        /* Evidence cards */
        .evidence-card {
            border: 1px solid var(--color-border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin-bottom: var(--space-3);
            transition: border-color 0.15s;
        }
        .evidence-card:hover { border-color: var(--color-border-default); }
        .evidence-card:last-child { margin-bottom: 0; }
        .evidence-card--contradicts {
            border-left: 3px solid var(--color-error);
        }
        .evidence-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: var(--space-3);
            margin-bottom: var(--space-2);
        }
        .evidence-title {
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--color-text-primary);
            margin: 0;
        }
        .evidence-title a { color: inherit; text-decoration: none; }
        .evidence-title a:hover { color: var(--color-accent-primary); }
        .evidence-agreement {
            flex-shrink: 0;
            padding: var(--space-1) var(--space-2);
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: var(--radius-sm);
            font-variant-numeric: tabular-nums;
        }
        .evidence-agreement--high { background: rgba(5, 150, 105, 0.1); color: var(--color-success); }
        .evidence-agreement--medium { background: rgba(217, 119, 6, 0.1); color: var(--color-warning); }
        .evidence-domain {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-bottom: var(--space-2);
        }
        .evidence-description {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            line-height: 1.6;
        }
        .matched-claims {
            margin-top: var(--space-3);
            padding: var(--space-3);
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-sm);
        }
        .matched-claim {
            margin-bottom: var(--space-2);
            padding-left: var(--space-3);
            border-left: 2px solid var(--color-accent-primary);
            font-size: 0.8125rem;
        }
        .matched-claim:last-child { margin-bottom: 0; }
        .matched-claim-label {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-2);
        }

        /* Cluster items */
        .cluster-item {
            padding: var(--space-3) 0;
            border-bottom: 1px solid var(--color-border-subtle);
        }
        .cluster-item:last-child { border-bottom: none; }
        .cluster-summary {
            font-size: 0.875rem;
            color: var(--color-text-primary);
            margin-bottom: var(--space-1);
        }
        .cluster-channel {
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-3) var(--space-5);
            font-size: 0.9375rem;
            font-weight: 600;
            color: white;
            background: var(--color-accent-primary);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-family: inherit;
            text-decoration: none;
            transition: background 0.15s;
        }
        .btn:hover { background: var(--color-accent-hover); text-decoration: none; }
        .btn--success { background: var(--color-success); }
        .btn--success:hover { background: #047857; }

        .shortcut-section {
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--color-border-subtle);
        }
        .shortcut-help {
            margin-top: var(--space-2);
            font-size: 0.8125rem;
            color: var(--color-text-muted);
        }

        /* Collapsible prompt */
        details {
            margin-top: var(--space-4);
        }
        details summary {
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-accent-primary);
            list-style: none;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        details summary::-webkit-details-marker { display: none; }
        details[open] summary .chevron { transform: rotate(180deg); }
        .chevron { transition: transform 0.15s; }
        .prompt-text {
            margin-top: var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            font-size: 0.8125rem;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 300px;
            overflow-y: auto;
            font-family: "SF Mono", "Fira Code", "Consolas", monospace;
        }

        .empty-state {
            color: var(--color-text-muted);
            font-style: italic;
            font-size: 0.875rem;
        }

        .footer {
            text-align: center;
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-top: var(--space-8);
            padding-top: var(--space-4);
            border-top: 1px solid var(--color-border-subtle);
        }

        :focus-visible {
            outline: 2px solid var(--color-accent-primary);
            outline-offset: 2px;
        }

        @media (prefers-reduced-motion: reduce) {
            * { animation: none !important; transition: none !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>{{.Item.Topic}}</h1>
            <div class="meta">
                {{if .Item.ChannelUsername}}
                via <a href="https://t.me/{{.Item.ChannelUsername}}" target="_blank" rel="noopener">@{{.Item.ChannelUsername}}</a>
                {{if .Item.ChannelTitle}}({{.Item.ChannelTitle}}){{end}}
                {{else}}
                via {{.Item.ChannelTitle}}
                {{end}}
                &bull; {{.Item.TGDate.Format "Jan 2, 2006 15:04"}}
                &bull; <a href="{{.OriginalMsgLink}}" target="_blank" rel="noopener">View original</a>
            </div>
            <div class="score-row">
                <div class="score-item">
                    <div class="score-bar">
                        <div class="score-fill {{if ge .Item.RelevanceScore 0.7}}score-fill--success{{else if ge .Item.RelevanceScore 0.4}}score-fill--warning{{end}}" style="width: {{printf "%.0f" (mul .Item.RelevanceScore 100)}}%"></div>
                    </div>
                    <div class="score-meta">
                        <span class="score-value">{{printf "%.0f" (mul .Item.RelevanceScore 100)}}%</span>
                        <span class="score-label">Relevance</span>
                    </div>
                </div>
                <div class="score-item">
                    <div class="score-bar">
                        <div class="score-fill {{if ge .Item.ImportanceScore 0.7}}score-fill--success{{else if ge .Item.ImportanceScore 0.4}}score-fill--warning{{end}}" style="width: {{printf "%.0f" (mul .Item.ImportanceScore 100)}}%"></div>
                    </div>
                    <div class="score-meta">
                        <span class="score-value">{{printf "%.0f" (mul .Item.ImportanceScore 100)}}%</span>
                        <span class="score-label">Importance</span>
                    </div>
                </div>
            </div>
            {{if .Item.MediaData | isImageMedia}}
            <div class="media-container">
                <img src="{{.Item.MediaData | mediaDataURL}}" alt="Message media" class="media-image">
            </div>
            {{end}}
        </div>

        <div class="card">
            <h2>Summary</h2>
            <p class="summary">{{if .AllowSafeHTML}}{{.Item.Summary | safeHTML}}{{else}}{{.Item.Summary | stripHTML}}{{end}}</p>
        </div>

        <div class="card" data-item-id="{{.Item.ID}}" data-annotation-token="{{.AnnotationToken}}">
            <h2>Annotate</h2>
            <div class="annotate-actions">
                <button class="annotate-btn good" data-rating="good" aria-label="Good">‚úÖ</button>
                <button class="annotate-btn bad" data-rating="bad" aria-label="Bad">‚ö†Ô∏è</button>
                <button class="annotate-btn irrelevant" data-rating="irrelevant" aria-label="Irrelevant">üö´</button>
                <button class="annotate-btn note" data-note aria-label="Add note">üìù</button>
                {{if .LastRating}}
                <span class="annotate-badge">{{.LastRating}}{{if .LastRatedAt}} ‚Ä¢ {{.LastRatedAt.Format "Jan 2 15:04"}}{{end}}</span>
                {{end}}
            </div>
            <div class="annotate-note">
                <input type="text" placeholder="Optional note‚Ä¶" maxlength="500" value="{{.LastFeedback}}" />
            </div>
            <div class="annotate-error" hidden></div>
        </div>

        <div class="card">
            <h2>Original Message</h2>
            <div class="original-text">{{.Item.Text}}</div>
        </div>

        {{if .Evidence}}
        <div class="card">
            <h2>Evidence Sources ({{len .Evidence}})</h2>
            {{range .Evidence}}
            <div class="evidence-card {{if .IsContradiction}}evidence-card--contradicts{{end}}">
                <div class="evidence-header">
                    <h3 class="evidence-title"><a href="{{.Source.URL}}" target="_blank" rel="noopener">{{if .Source.Title}}{{.Source.Title}}{{else}}{{.Source.URL}}{{end}}</a></h3>
                    <span class="evidence-agreement {{if ge .AgreementScore 0.7}}evidence-agreement--high{{else}}evidence-agreement--medium{{end}}">{{printf "%.0f" (mul .AgreementScore 100)}}%</span>
                </div>
                <div class="evidence-domain">
                    {{.Source.Domain}}
                    {{if .IsContradiction}}&bull; <strong style="color: var(--color-error);">Contradicts</strong>{{end}}
                </div>
                {{if .Source.Description}}<p class="evidence-description">{{.Source.Description}}</p>{{end}}
                {{$claims := .MatchedClaimsJSON | parseMatchedClaims}}
                {{if $claims}}
                <div class="matched-claims">
                    <div class="matched-claim-label">Matched Claims</div>
                    {{range $claims}}
                    <div class="matched-claim">
                        <div><strong>Item:</strong> {{.ItemClaim}}</div>
                        <div><strong>Evidence:</strong> {{.EvidenceClaim}}</div>
                    </div>
                    {{end}}
                </div>
                {{end}}
            </div>
            {{end}}
        </div>
        {{else}}
        <div class="card">
            <h2>Evidence Sources</h2>
            <p class="empty-state">No evidence available for this item.</p>
        </div>
        {{end}}

        {{if .ClusterItems}}
        <div class="card">
            <h2>Related Items in Cluster</h2>
            {{range .ClusterItems}}
            <div class="cluster-item">
                <div class="cluster-summary">{{.Summary | stripHTML}}</div>
                <div class="cluster-channel">
                    {{if .ChannelUsername}}
                    via <a href="https://t.me/{{.ChannelUsername}}/{{.MessageID}}" target="_blank" rel="noopener">@{{.ChannelUsername}}</a>
                    {{else if .ChannelPeerID}}
                    via <a href="https://t.me/c/{{.ChannelPeerID}}/{{.MessageID}}" target="_blank" rel="noopener">private channel</a>
                    {{end}}
                </div>
            </div>
            {{end}}
        </div>
        {{end}}

        {{if .ShortcutEnabled}}
        <div class="card">
            <h2>Deep Dive with ChatGPT</h2>
            <p style="margin-bottom: var(--space-4); color: var(--color-text-secondary);">Tap below to explore this topic further with ChatGPT.</p>

            <div class="shortcut-section">
                <a href="{{.ShortcutURL | safeURL}}" class="btn btn--success">
                    Ask on iPhone/Mac
                </a>
                <div class="shortcut-help">
                    Requires <a href="{{.ShortcutICloudURL}}" target="_blank" rel="noopener">one-time shortcut installation</a>
                </div>
            </div>

            <details>
                <summary>
                    <span>View prompt</span>
                    <svg class="chevron" width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </summary>
                <div class="prompt-text">{{.ChatGPTPrompt}}</div>
            </details>
        </div>
        {{end}}

        <div class="footer">
            Generated {{.GeneratedAt.Format "Jan 2, 2006 15:04:05 MST"}}
        </div>
    </div>
    <script>
      const annotateCard = document.querySelector("[data-item-id]");
      if (annotateCard) {
        const itemId = annotateCard.dataset.itemId;
        const token = annotateCard.dataset.annotationToken;
        const buttons = annotateCard.querySelectorAll(".annotate-btn[data-rating]");
        const noteBtn = annotateCard.querySelector(".annotate-btn.note");
        const noteWrap = annotateCard.querySelector(".annotate-note");
        const noteInput = annotateCard.querySelector(".annotate-note input");
        const errorEl = annotateCard.querySelector(".annotate-error");

        const setError = (msg) => {
          if (!errorEl) return;
          if (!msg) {
            errorEl.hidden = true;
            errorEl.textContent = "";
            return;
          }
          errorEl.hidden = false;
          errorEl.textContent = msg;
        };

        const annotate = async (rating) => {
          setError("");
          buttons.forEach(b => b.disabled = true);
          const payload = {
            item_id: itemId,
            rating,
            comment: noteInput ? noteInput.value.trim() : "",
            source: "web-expanded"
          };
          try {
            const res = await fetch("/research/annotate", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-Expanded-Token": token
              },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!res.ok || !data.ok) {
              throw new Error(data.message || "Failed to save annotation");
            }
          } catch (err) {
            setError(err.message || "Failed to save annotation");
          } finally {
            buttons.forEach(b => b.disabled = false);
          }
        };

        buttons.forEach(btn => {
          btn.addEventListener("click", () => annotate(btn.dataset.rating));
        });
        if (noteBtn && noteWrap) {
          noteBtn.addEventListener("click", () => {
            noteWrap.style.display = noteWrap.style.display === "block" ? "none" : "block";
          });
        }
      }
    </script>
</body>
</html>
